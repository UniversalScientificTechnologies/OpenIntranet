{% extends "base.hbs" %}
{% block title %} UST intranet | Adresář{%end%}
{% block body %}

<style>
    body {
        overflow: hidden;
        height: 100%;
    }

    #body {
        width: 100%;
        height: 100%;
        overflow: auto;
    }

    #users-table-control-panel {
        width: 100%;
        padding: 5px;
    }

    #users-table-wrapper {
        margin-left: -15px;
        margin-right: -15px;
    }

    #save-btn {
        float: right;
    }

    #messages-span {
        padding-left: 10px;
        vertical-align: middle;
    }

    .tabulator {
        user-select: none;
    }

    #new-user-form-wrapper {
        width: 50%;
        margin-left: auto;
        margin-right: auto;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col">
            <h1>Tabulka uživatelů</h1>
            <div id="users-table-wrapper">
                <div id="users-table-control-panel">
                    <div class="btn-group" role="group">
                        <button id="undo-btn" type="button" class="btn btn-light" onclick="undoTableAction()">
                            Vzít zpět
                        </button>
                        <button id="redo-btn" type="button" class="btn btn-light" onclick="redoTableAction()">
                            Znovu
                        </button>
                    </div>
                    <span id="messages-span"></span>
                    <button id="save-btn" type="button" class="btn btn-light" onclick="saveUsersEdits()">Uložit</button>
                </div>
                <div id="users-table"></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h1>Přidat uživatele</h1>

            <div id="new-user-form-wrapper">
                <form>
                    <div class="form-group row">
                        <label for="pre-name-title-input" class="col-3 col-form-label">Titul před jménem</label>
                        <div class="col">
                            <input type="text" class="form-control" id="pre-name-title-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="first-name-input" class="col-3 col-form-label">Jméno</label>
                        <div class="col">
                            <input type="text" class="form-control" id="first-name-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="surname-input" class="col-3 col-form-label">Příjmení</label>
                        <div class="col">
                            <input type="text" class="form-control" id="surname-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="post-name-title-input" class="col-3 col-form-label">Titul za jménem</label>
                        <div class="col">
                            <input type="text" class="form-control" id="post-name-title-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="email-input" class="col-3 col-form-label">Email</label>
                        <div class="col">
                            <input type="text" class="form-control" id="email-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="roles-input" class="col-3 col-form-label">Role</label>
                        <div class="col">
                            <input type="text" class="form-control" id="roles-input">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="assignment-input" class="col-3 col-form-label">Pracovní náplň</label>
                        <div class="col">
                            <input type="text" class="form-control" id="assignment-input">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" onclick="addUserSubmit()">Přidat uživatele</button>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <br><br><br>
    </div>
</div>

<script type="text/javascript">

    /**
     * Uchovává rozdíl mezi původními daty a daty změněnými administrátorem v tabulce.
     *
     * Formát: {
     *     "old_data": {
     *         <id uživatele 1>: {
     *             <field1>: <nová hodnota fieldu 1>,
     *             <field2>: <nová hodnota fieldu 2>,
     *         }
     *     }
     *     "new_data": {
     *         <id uživatele 1>: {
     *             <field1>: <stará hodnota fieldu 1>,
     *             <field2>: <stará hodnota fieldu 2>,
     *         }
     *     }
     * }
     */
    let editedData = {
        "old_data": {},
        "new_data": {},
    };

    /**
     * Připraví tabulátor a callbacky.
     * Očekávané chování: některé sloupce jsou editovatelné na double click. Je-li nová hodnota jiná
     * než hodnota v databázi, editovaná buňka se podbarví šedě.
     *
     * Možný zdroj chyb: buňky momentálně nejsou obarvované pomocí formateru ale přímo v cellDataEdited.
     * Dojde-li ke změně dat v buňce bez volání cellDataEdited, podbarvení se nezmění.
     * V tuto chvíli nevím o takové možnosti kromě undo/redo, které jsou ošetřené.
     * TODO Zkusit to udělat lépe
     */
    function drawTable() {

        /**
         * Smaže poslední oznámení z messages-span.
         */
        let clearMessage = function () {
            $("#messages-span").text("");
        };

        /**
         * Callback tabulatoru. Editace buněk tabulatoru na doubleclick.
         * Zdroj: https://github.com/olifolkerd/tabulator/issues/631
         */
        let dblClickEditFunc = function (e, cell) {
            clearMessage();
            cell.edit(true);
        };

        /**
         * Callback tabulatoru. Invertuje bool hodnotu buňky.
         */
        let boolCellChangeValue = function (e, cell) {
            clearMessage();
            cell.setValue(!cell.getValue());
            e.preventDefault()
        };

        /**
         * Callback tabutatoru. Zobrazí varování po doubleclicku na needitovatelnou buňku.
         */
        let uneditableMsg = function (e, cell) {
            clearMessage();
            $("#messages-span").text("Tato buňka není editovatelná")
        };

        /**
         * Callback tabulatoru. Volá se po změně dat v buňce.
         *
         * Stará i nová data jsou uložena v proměnné editedData (viz dok.). Stará data jsou uložena jen
         * poprvé, tzn. je to původní hodnota v databázi. Odpovídá-li nová hodnota staré, obě jsou z
         * editedData odstraněny. Je-li odstraněna poslední upravená hodnota nějakého id, id se odstraní.
         *
         * Liší-li se stará a nová data, buňka je podbarvena šedě.
         */
        let cellDataEdited = function (cell) {
            let id = cell.getRow().getData().id;
            let field = cell.getField();

            let oldV = cell.getOldValue();
            let newV = cell.getValue();

            if (oldV === newV) {
                return
            }

            if (!(id in editedData.old_data)) {
                editedData.old_data[id] = {};
                editedData.new_data[id] = {};
            }

            if (!(field in editedData.old_data[id])) {
                editedData.old_data[id][field] = oldV;

                cell.getElement().style.backgroundColor = "#f5f5f5";
            }

            if (editedData.old_data[id][field] === newV) {
                delete editedData.old_data[id][field];
                delete editedData.new_data[id][field];

                cell.getElement().style.backgroundColor = "";

                if ($.isEmptyObject(editedData.old_data[id])) {
                    delete editedData.old_data[id];
                    delete editedData.new_data[id];
                }
            } else {
                editedData.new_data[id][field] = newV;
            }
            console.log(editedData);
        };

        /**
         * Callback tabulatoru. Při undo/redo se defaultně nevolá cellEdited, voláme ji zde tedy ručně.
         */
        let historyHappened = function (action, component, data) {
            if (component.constructor.name === "CellComponent") {
                cellDataEdited(component);
            }
        };

        return new Tabulator("#users-table", {
            width: '100%',
            height: '500px',
            movableColumns: true,
            history: true,
            cellEdited: cellDataEdited,
            historyUndo: historyHappened,
            historyRedo: historyHappened,
            columns: [
                {
                    title: "Přijmení",
                    field: "surname",
                    frozen: true,
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,

                },
                {
                    title: "Jméno",
                    field: "first_name",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "ID",
                    field: "id",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Email",
                    field: "email",
                    sorter: "string",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Email ověřen",
                    field: "email_validate",
                    formatter: "tickCross",
                    align: "center",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Telefon",
                    field: "phone_number",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Datum narození",
                    field: "birthdate",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Bydliště",
                    field: "home_address",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Kontaktní adresa",
                    field: "contact_address",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Číslo účtu",
                    field: "account_number",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Role",
                    field: "role",
                    sorter: "string",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Pracovní náplň",
                    field: "assignment",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Dovednosti",
                    field: "skills",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
                {
                    title: "Datum založení účtu",
                    field: "created",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Typ smlouvy",
                    field: "contract_type",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Konec platnosti smlouvy",
                    field: "contract_expiration_date",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Je smlouva platná?",
                    field: "is_valid",
                    formatter: "tickCross",
                    align: "center",
                    cellDblClick: boolCellChangeValue,
                },
                {
                    title: "Potvrzení o studiu",
                    field: "certificate_of_study",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Prohlášení k dani",
                    field: "tax_evasion",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Hodinová mzda",
                    field: "hour_rate",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Odpracováno hodin za tento měsíc",
                    field: "hours_worked_this_month",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Aktuální hrubá mzda",
                    field: "actual_gross_wage",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Odpracováno hodin za minulý měsíc",
                    field: "hours_worked_last_month",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Hrubá mzda za minulý měsíc",
                    field: "last_months_gross_wage",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Nejbližší dovolená",
                    field: "next_vacation",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Měsíc uzavřen",
                    field: "month_closed",
                    formatter: "tickCross",
                    align: "center",
                    cellDblClick: uneditableMsg,
                },
                {
                    title: "Poznámky",
                    field: "notes",
                    editor: "input",
                    editable: false,
                    cellDblClick: dblClickEditFunc,
                },
            ],
            ajaxURL: "users/api/user/get",
            ajaxConfig: {
                method: "GET",
                headers: {
                    "Content-type": 'application/json; charset=utf-8', //set specific content type
                },
            }
        });
    }

    table = drawTable();

    /**
     * onclick handler tlačítka vzít zpět.
     * není-li co vzít zpět, zobrazí oznámení.
     */
    function undoTableAction() {
        let undone = table.undo();
        if (undone) {
            $("#messages-span").text("")
        } else {
            $("#messages-span").text("Není co vzít zpět")
        }
    }

    /**
     * onclick handler tlačítka znovu.
     * není-li co provést znovu, zobrazí oznámení.
     */
    function redoTableAction() {
        let redone = table.redo();
        if (redone) {
            $("#messages-span").text("")
        } else {
            $("#messages-span").text("Není co provést znovu")
        }
    }

    /**
     * onclick handler tlačítka přidat uživatele.
     */
    function addUserSubmit() {
        let data = {
            pre_name_title: $('#pre-name-title-input').val(),
            first_name: $('#first-name-input').val(),
            surname: $('#surname-input').val(),
            post_name_title: $('#post-name-title-input').val(),
            email: $('#email-input').val(),
            roles: $('#roles-input').val(),
            assignment: $('#assignment-input').val(),
        };
        $.ajax({
            url: "/users/api/user/add",
            type: "post",
            data: data,
            success: function (response) {
                console.log(response);
                console.log("yay!")
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log("nay!")
            }
        });

    }

    /**
     * onclick handler tlačítka uložit (změny dat v tabulce uživatelů)
     * Ajaxem odesílá zřetězcovaný editedData.new_data
     */
    function saveUsersEdits() {
        let data = {data: JSON.stringify(editedData.new_data)};

        $.ajax({
            url: "/users/api/user/edit",
            type: "post",
            data: data,
            success: function (response) {
                console.log(response);
                console.log("yay!")
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus, errorThrown);
                console.log("nay!")
            }
        });

        console.log(data);
    }
</script>

{% end %}{# block body#}
